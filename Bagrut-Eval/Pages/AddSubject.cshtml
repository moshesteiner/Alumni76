@page
@model AddSubjectModel
@{
    ViewData["Title"] = "ניהול מקצועות";
}

<div class="full-width-content rtl-layout">
    @* <h1>ניהול מקצועות</h1> *@
    <br />

    @* Display Success/Error Messages from TempData *@   
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @Html.Raw(TempData["SuccessMessage"])
        </div>
    }
    @*  @if(TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @Html.Raw(TempData["ErrorMessage"])
            Moshe
        </div>
    } *@
    <br />
    <div class="full-width-content rtl-layout">
        @* --- Add New Subject --- *@
        <div class="card mb-5" style="max-width: 500px;">
            <div class="card-header">
                <h4>הוספת מקצוע חדש</h4>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="AddSubject">
                    <div class="form-group mb-3">
                        <label asp-for="NewSubject.Title"></label>
                        <input asp-for="NewSubject.Title" class="form-control" />
                        <span asp-validation-for="NewSubject.Title" class="text-danger"></span>
                    </div>
                    <button type="submit" class="btn btn-primary">הוסף מקצוע</button>
                </form>
            </div>
        </div>

        @* --- Existing Subjects List --- *@       
        <div class="card mb-5" style="max-width: 600px;">
            <div class="card-header">
                <h4>רשימת מקצועות קיימים</h4>
            </div>
            @{
                var line = 1;
            }
            @if (Model.Subjects.Any())
            {
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>מזהה</th>
                            <th>שם המקצוע</th>
                            <th style="width: 120px;">עדכן</th>
                            <th style="width: 120px;">פעיל</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var subject in Model.Subjects)
                        {
                            <tr id="subject_row_@subject.Id">
                                <td>@(line++)</td>
                                <td>@subject.Id</td>
                                <td>
                                    <input type="text"
                                           class="form-control subject-title-input"
                                           id="title_input_@subject.Id"
                                           value="@subject.Title"
                                           data-original-title="@subject.Title" />
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-sm btn-success save-btn"
                                            data-id="@subject.Id">
                                        עדכן
                                    </button>
                                </td>
                                <td>
                                    @{
                                        var isActive = subject.Active;
                                        var statusText = isActive ? "פעיל" : "לא פעיל"; 
                                        var buttonClass = isActive ? "btn-success" : "btn-danger"; // Green/Red
                                    }
                                    <button type="button"
                                            class="btn btn-sm @buttonClass toggle-active-btn"
                                            data-id="@subject.Id">
                                        @statusText
                                    </button>
                                </td>                                
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>לא נמצאו מקצועות.</p>
            }
        </div>

    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            // --- Helper function must be defined here to be accessible ---
            function toggleButtons(subjectId, enable) {
                const row = $(`#subject_row_${subjectId}`);
                row.find('.save-btn').prop('disabled', !enable);
                row.find('.cancel-btn').prop('disabled', !enable);
                row.find(`#title_input_${subjectId}`).prop('disabled', !enable);
            }
                const storedErrorMessage = sessionStorage.getItem('SubjectUpdateError');
                if (storedErrorMessage) {
                    // Clear the storage immediately
                    sessionStorage.removeItem('SubjectUpdateError');

                    // Call the C# handler to officially set TempData["ErrorMessage"]
                    // The fetch call executes the OnGetSetTempDataError method on the server.
                    fetch(`?handler=SetTempDataError&message=${encodeURIComponent(storedErrorMessage)}`, { method: 'GET' })
                        .then(response => {
                             // Console message confirms the server-side code was triggered.
                             console.log("Error transferred to TempData.");
                        })
                        .catch(error => {
                            console.error("Failed to transfer error to TempData:", error);
                        });
                }

            // --- Event listener for CANCEL button ---
            $(document).on('click', '.cancel-btn', function () {
                const subjectId = $(this).data('id');
                const row = $(`#subject_row_${subjectId}`);

                // Get the original title from the data attribute on the input field
                const originalTitle = row.find(`#title_input_${subjectId}`).data('original-title');

                // Reset the input value to the original title
                row.find(`#title_input_${subjectId}`).val(originalTitle);
            });

            // --- Event listener for SAVE button (AJAX POST) ---
            $(document).on('click', '.save-btn', async function () {
                const button = $(this);
                const subjectId = button.data('id');
                const row = $(`#subject_row_${subjectId}`);
                const inputField = row.find(`#title_input_${subjectId}`);
                const newTitle = inputField.val().trim();
                const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

                if (!newTitle) {
                    alert('שם המקצוע אינו יכול להיות ריק.');
                    return;
                }

                const originalTitle = inputField.data('original-title');
                if (newTitle === originalTitle) {
                    alert('לא בוצע שינוי בשם המקצוע.');
                    return;
                }

                // 🛑 This call should now work because toggleButtons is in scope 🛑
                toggleButtons(subjectId, false); // Disable input and buttons
                button.text('שומר...');

                let failureMessage = null;

                try {
                    const response = await fetch(`?handler=UpdateSubject`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': antiForgeryToken
                        },
                        body: `id=${subjectId}&title=${encodeURIComponent(newTitle)}`
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        try {
                            const result = JSON.parse(errorText);
                            failureMessage = result.message || 'שגיאה לא ידועה.';
                        } catch {
                            failureMessage = 'שגיאה לא צפויה מהשרת.';
                        }
                    } else {
                        const result = await response.json();

                        if (result.success) {
                            inputField.data('original-title', newTitle);

                            row.css('background-color', '#d4edda');
                            setTimeout(() => {
                                row.css('background-color', '');
                            }, 500);

                        } else {
                            failureMessage = result.message;
                        }
                    }
                } catch (error) {
                    console.error('AJAX error:', error);
                    failureMessage = 'שגיאה כללית בשמירה.';
                } finally {
                    // Re-enable buttons only if we are NOT reloading
                    if (!failureMessage) {
                        toggleButtons(subjectId, true);
                    }
                    button.text('שמור');

                    if (failureMessage) {
                        // Store the error message and then reload
                        sessionStorage.setItem('SubjectUpdateError', failureMessage);
                        nativeAlert(failureMessage);
                        // alert(failureMessage);

                        location.reload();
                    }
                }
            });
        });


        // --- Event listener for TOGGLE ACTIVE button (AJAX POST) ---
        $(document).on('click', '.toggle-active-btn', async function () {
            const button = $(this);
            const subjectId = button.data('id');
            const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

            button.prop('disabled', true).text('מעדכן...');

            let failureMessage = null;

            try {
                const response = await fetch(`?handler=ToggleActiveStatus&id=${subjectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': antiForgeryToken
                    }
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        // Get new status from server response
                        const newStatus = result.newActiveStatus;
                        const newText = newStatus ? 'פעיל' : 'לא פעיל';
                        const newClass = newStatus ? 'btn-success' : 'btn-danger';

                        // Update button text and color
                        button.text(newText);
                        button.removeClass('btn-success btn-danger').addClass(newClass);
                        button.data('is-active', newStatus.toString().toLowerCase());

                        // Display success message using your existing TempData logic
                        sessionStorage.setItem('SubjectUpdateSuccess', result.message);
                        location.reload();
                    } else {
                        failureMessage = result.message;
                    }
                } else {
                    const errorText = await response.text();
                    // Try to parse the error message if it's a JSON response from our handler
                    try {
                        const result = JSON.parse(errorText);
                        failureMessage = result.message || 'שגיאה לא ידועה.';
                    } catch {
                        failureMessage = 'שגיאה לא צפויה מהשרת.';
                    }
                }
            } catch (error) {
                console.error('AJAX error:', error);
                failureMessage = 'שגיאה כללית בהפעלה.';
            } finally {
                button.prop('disabled', false); // Re-enable button on failure
                if (failureMessage) {
                    // Handle failure by alerting and maybe reloading to clear state
                    sessionStorage.setItem('SubjectUpdateError', failureMessage);
                    alert(failureMessage);
                    // Optionally, reload to refresh the list state
                    location.reload();
                }
            }
        });
    </script>
}
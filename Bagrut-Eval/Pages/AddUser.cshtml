@page
@model Bagrut_Eval.Pages.AddUserModel
@{
    ViewData["Title"] = "הוספת מעריך";
}

<div class="container mt-4">
    @* 
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.ModelState.IsValid ? "alert-success" : "alert-danger")" role="alert">
            @Model.Message
        </div>
    }
 *@
    @* FIX: Display Success Message from TempData after a Redirect *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @Html.Raw(TempData["SuccessMessage"])
        </div>
    }

    @* FIX: Display Error Message from TempData after a Redirect (from other parts of the code) *@
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }

    @* Keep the existing Model.Message check for non-redirect validation failures *@
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.ModelState.IsValid ? "alert-success" : "alert-danger")" role="alert">
            @Model.Message
        </div>
    }

    <div class="mb-4">
        <form id="addUserForm" method="post">
            @Html.AntiForgeryToken()
            <div id="newUser" class="row">
                <div id="newUserData" class="col-md-4 order-md-1">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5 class="mb-0">פרטי משתמש חדש</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="NewUser.FirstName" class="form-label">שם פרטי</label>
                                <input asp-for="NewUser.FirstName" class="form-control" />
                                <span asp-validation-for="NewUser.FirstName" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="NewUser.LastName" class="form-label">שם משפחה</label>
                                <input asp-for="NewUser.LastName" class="form-control" />
                                <span asp-validation-for="NewUser.LastName" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="NewUser.Email" class="form-label">אימייל</label>
                                <input asp-for="NewUser.Email" class="form-control" />
                                <span asp-validation-for="NewUser.Email" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="NewUser.Phone" class="form-label">טלפון</label>
                                <input asp-for="NewUser.Phone" class="form-control" />
                                <span asp-validation-for="NewUser.Phone" class="text-danger"></span>
                            </div>
                            @*
                            <div class="mb-3">
                                <label asp-for="UserPassword" class="form-label">סיסמה</label>
                                <input asp-for="UserPassword" type="password" class="form-control" />
                                <span asp-validation-for="UserPassword" class="text-danger"></span>
                            </div>
                            *@
                            <div class="mb-3">
                                <label asp-for="NewUserRole" class="form-label">תפקיד</label>
                                <select asp-for="NewUserRole" class="form-control">
                                    <option value="" disabled selected hidden>בחר תפקיד</option>
                                    <option value="Evaluator">מעריך</option>
                                    <option value="Senior">מעריך בכיר</option>
                                    <option value="Admin">מנהל מערכת</option>
                                </select>
                                <span asp-validation-for="NewUserRole" class="text-danger"></span>
                            </div>
                            @if (Model.IsSpecialAdmin)
                            {
                                <div class="mb-3">
                                    <label asp-for="SelectedSubjectId" class="form-label">מקצוע</label>
                                    <select asp-for="SelectedSubjectId" class="form-control">
                                        <option value="" disabled selected hidden>בחר מקצוע</option>
                                        @foreach (var opt in Model.AvailableSubjects!)
                                        {
                                            <option value=@opt.Value>@opt.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="SelectedSubjectId" class="text-danger"></span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                @if (!Model.IsSpecialAdmin)
                {
                    <div id="newUserExam" class="col-md-6 order-md-2">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">בחינות מורשות</h5>
                            </div>
                            <div class="card-body">

                                @if (Model.AvailableExamsList != null && Model.AvailableExamsList.Any())
                                {
                                    <div class="form-group">
                                        @foreach (var exam in Model.AvailableExamsList)
                                        {
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="exam_@exam.Id"
                                                       name="SelectedExamIds"
                                                       value="@exam.Id"
                                                       @(Model.SelectedExamIds != null && Model.SelectedExamIds.Contains(exam.Id) ? "checked" : "")>
                                                <label class="form-check-label" for="exam_@exam.Id">
                                                    @exam.ExamTitle
                                                </label>
                                            </div>
                                            <br />
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p>אין בחינות זמינות להוספה</p>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <input type="hidden" asp-for="NewUser.Active" value="True" />
            <button type="submit" id="submitAddUser" style="display: none;"></button>            

            <div id="actionButtons" class="justify-content-end align-items-center text-center mt-3">
                <button type="submit" class="btn btn-primary me-2">הוסף</button>
                <a asp-page="/Index" class="btn btn-secondary me-2">ביטול</a>
                @if (!Model.IsSpecialAdmin)
                {
                    <button type="button" class="btn btn-primary me-2" onclick="document.getElementById('bulkAddFileInput').click();">טעינה מקובץ</button>
                    <button type="button" class="btn btn-info" onclick="showBulkAddHelp()">עזרה</button>
                }
            </div>
        </form>

        <form id="bulkAddForm" method="post" asp-page-handler="BulkAdd" enctype="multipart/form-data">
            <input type="file" id="bulkAddFileInput" name="BulkAddFile" style="display: none;" onchange="this.form.submit()" accept=".xlsx" />
            <button type="submit" id="submitBulkAdd" style="display: none;"></button>
        </form>

        <hr class="my-4">

        @*
        <div id="actionButtons" class="justify-content-end align-items-center">
            <center>
                <button type="button" class="btn btn-primary me-2" onclick="document.getElementById('submitAddUser').click();">הוסף ללא ספינר</button>
                <button type="button" class="btn btn-primary me-2" id="addUserTrigger">הוסף</button>

                <a asp-page="/Index" class="btn btn-secondary me-2">ביטול</a>
                @if (!Model.IsSpecialAdmin)
                {
                    <button type="button" class="btn btn-primary me-2" onclick="document.getElementById('bulkAddFileInput').click();">טעינה מקובץ</button>
                    <button type="button" class="btn btn-info" onclick="showBulkAddHelp()">עזרה</button>
                }
            </center>
        </div>
        *@
    </div>
</div>
<style>
    /* Custom style to ensure all buttons in the action bar have the same font size */
    #actionButtons .btn {
        font-size: 1.1em;
        padding: 0.5rem 1rem !important;
        margin-right: 1em !important;
    }
</style>
<div class="modal fade" id="bulkUsersModal" tabindex="-1" aria-labelledby="bulkUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="bulkUsersModalLabel">רשימת מעריכים שנוספה</h5>
            </div>
            <div class="modal-body">
                <ul id="bulkUsersList">
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="excelHelpModal" tabindex="-1" aria-labelledby="excelHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-custom-width">        @* modal-xl *@
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <h5 class="modal-title" id="excelHelpModalLabel">&nbsp&nbsp סדר עמודות בקובץ אקסל - יש להקפיד על שם בחינה מדויק</h5>
            </div>
            <div class="modal-body text-center">
                <img src="~/images/users.png" class="help-image" alt="סדר עמודות אקסל" />    @* class="img-fluid" *@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">סגור</button>
            </div>
        </div>
    </div>
</div>
<style>
    .modal-custom-width {
        max-width: 1100px;
        margin: 1.75rem auto;
    }

    .help-image {
        max-width: 900px;
        width: 100%;
        height: auto;
    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
            document.addEventListener('DOMContentLoaded', function () {
            const bulkUsersHtml = '@Html.Raw(TempData["BulkUsers"])';

            // Check if the string data exists
            if (bulkUsersHtml && bulkUsersHtml.trim().length > 0) {
                // Get the <ul> element to populate
                const bulkUsersList = document.getElementById('bulkUsersList');
                bulkUsersList.innerHTML = ''; // Clear any previous content

                // Split the string by the <br /> tag to get individual user lines
                const bulkUsersArray = bulkUsersHtml.split('<br />');

                // Loop through the data and create list items
                bulkUsersArray.forEach(userLine => {
                    if (userLine.trim().length > 0) {
                        const li = document.createElement('li');
                        li.textContent = userLine.trim();
                        bulkUsersList.appendChild(li);
                    }
                });

                // Show the Bootstrap modal
                const bulkUsersModal = new bootstrap.Modal(document.getElementById('bulkUsersModal'));
                bulkUsersModal.show();
            }
        });

            document.addEventListener('DOMContentLoaded', () => {
            const trigger = document.getElementById('addUserTrigger');
            const form = document.getElementById('addUserForm');

            trigger.addEventListener('click', () => {
                form.requestSubmit(); // fires submit event, spinner logic runs
            });
        });

        function showBulkAddHelp() {
        //         const message = `
        // סדר העמודות בקובץ האקסל צריך להיות:
        // FirstName,LastName,Email,Role,Exam1,Exam2

        // * התפקיד חייב להיות באנגלית: Evaluator / Senior / Admin
        // * ניתן להזין עד 2 בחינות למעריך. יש להקפיד על שם בחינה מדויק.
        // * הסיסמה שתיווצר תישלח באימייל
        // * מומלץ לשנות אותה בהקדם.
        //         `.trim();
        //         alert(message);

                const myModal = document.getElementById('excelHelpModal');
                // 2. Create a new Bootstrap Modal instance
                const bsModal = new bootstrap.Modal(myModal);
                // 3. Show the modal
                bsModal.show();
            }
    </script>
}
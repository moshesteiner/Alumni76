@page
@model Bagrut_Eval.Pages.Metrics.ExportPageModel
@{
    ViewData["Title"] = "ייצוא תשובות למסמך Word";
}

<div class="container-fluid">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }
    <div id="ExamSelect" class="d-flex align-items-center mb-5">
        <form method="post" asp-page-handler="SelectExam" class="me-3">
            <div id="ExamSelRight" class="form-group d-flex align-items-center">
                <label asp-for="SelectedExamId" class="me-3 exam-label">בחר בחינה:</label> @*"col-sm-1 col-form-label"*@
                <select asp-for="SelectedExamId" asp-items="Model.AvailableExams" class="form-control" onchange="this.form.submit()">
                    <option value="">-- בחר בחינה --</option>
                </select>
            </div>
            <div id="ExamSelLeft" class="form-group d-flex align-items-center">
                @if (Model.SelectedExamId.HasValue && Model.Exports.Any())
                {
                    <h3>גיליון עריכה ויצוא עבור בחינה: @Model.SelectedExamTitle</h3>  @*class="mt-4"*@
                }
            </div>
        </form>
    </div>
    <style>
        #ExamSelect form {
            display: flex;
            /* justify-content: space-between; */
            align-items: center;
            width: 100%;
        }

        #ExamSelRight {
            flex: 2;
        }

        #ExamSelLeft {
            flex: 3;
            margin-right: 25px;
        }

        .exam-label {
            margin-right: 10px;
        }

        .exportTable th,
        .exportTable td,
        .exportTable textarea,
        .exportTable input {
            padding: 0px 8px 0px 8px;
            margin: 0px;
        }


            .exportTable input.form-control,
            .exportTable textarea.form-control {
                height: calc(1em + .75rem + 2px);
                font-size: 1em;
                box-sizing: border-box !important;
            }
    </style>
    <hr />

    @if (Model.SelectedExamId.HasValue && Model.Exports.Any())
    {
        @if (Model.IsShowOnlyExported)
        {
            <form id="exportForm" method="post" asp-page-handler="UpdateAndExport">
                <input type="hidden" asp-for="SelectedExamId" />
                <input type="hidden" asp-for="UpdateInput.FileName" id="fileNameInput" />
                <table class="table table-bordered mt-3 exportTable">
                    <thead>
                        <tr>
                            <th>סעיף</th>
                            <th>תיאור בעיה</th>
                            <th>שם מעריך בכיר</th>
                            <th>תשובה סופית / ערוכה</th>
                            <th>ציון סופי / ערוך</th>
                            <th>ייצוא</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var export in Model.Exports)
                        {
                            <tr>
                                @{
                                    var item = export.Issue!.QuestionNumber + export.Issue.Part?.QuestionPart;
                                }
                                <td>@item</td>
                                <td>@export.Issue.Description</td>
                                <td>@export.Senior!.FirstName @export.Senior.LastName</td>
                                <td>
                                    @if (string.IsNullOrEmpty(export.Description))
                                    {
                                        @export.Issue.FinalAnswer?.Content
                                    }
                                    else
                                    {
                                        @export.Description
                                    }
                                </td>
                                <td>
                                    @if (string.IsNullOrEmpty(export.Score))
                                    {
                                        @export.Issue.FinalAnswer?.Score
                                    }
                                    else
                                    {
                                        @export.Score
                                    }
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" checked="@export.Exported" disabled />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="d-flex justify-content-end">
                    <button type="button" id="exportButton1" class="btn btn-success m-2">יצוא ל-Word</button>
                    <button type="submit" asp-page-handler="CancelShow" class="btn btn-secondary m-2">חזור לדף הקודם</button>
                </div>
            </form>
        }
        else
        {
            <form id="exportForm" method="post" asp-page-handler="UpdateAndExport">
                <input type="hidden" asp-for="SelectedExamId" />
                <input type="hidden" asp-for="UpdateInput.FileName" id="fileNameInput" />
                <table class="table table-bordered mt-3 exportTable">
                    <thead>
                        <tr>
                            <th rowspan="2" width="8%">סעיף</th>
                            <th rowspan="2" width="30%">תיאור בעיה</th>
                            <th rowspan="2" width="15%">שם מעריך בכיר</th>
                            <th colspan="2" width="40%">תשובה סופית</th>
                            <th rowspan="2" width="5%">ייצוא</th>
                        </tr>
                        <tr>
                            <th colspan="2">עריכת התשובה וההורדה</th>
                            @* <th>הורדה / עריכה</th> *@
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var export in Model.Exports)
                        {
                            <tr>
                                @{
                                    var item = export.Issue!.QuestionNumber + export.Issue.Part?.QuestionPart;
                                }
                                <td rowspan="2">@item</td>
                                <td rowspan="2">@export.Issue.Description</td>
                                <td rowspan="2">@export.Senior!.FirstName @export.Senior.LastName</td>
                                <td>
                                    @if (string.IsNullOrEmpty(export.Description))
                                    {
                                        @export.Issue.FinalAnswer?.Content
                                    }
                                    else
                                    {
                                        @export.Description
                                    }
                                </td>
                                <td>
                                    @if (string.IsNullOrEmpty(export.Score))
                                    {
                                        @export.Issue.FinalAnswer?.Score
                                    }
                                    else
                                    {
                                        @export.Score
                                    }
                                </td>
                                <td rowspan="2" class="text-center">
                                    <input type="checkbox" asp-for="UpdateInput.IsExported[@export.IssueId]" class="export-checkbox" />
                                </td>
                            </tr>
                            <tr>
                                <td width="35%">
                                    <textarea asp-for="UpdateInput.Descriptions[@export.IssueId]" class="form-control" placeholder="ניסוח סופי למחוון"></textarea>
                                </td>
                                <td>
                                    <input type="text" asp-for="UpdateInput.Scores[@export.IssueId]" class="form-control" placeholder="הורדה" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="d-flex justify-content-end">
                    <button type="submit" asp-page-handler="Update" class="btn btn-primary m-2">עדכון</button>
                    <button type="submit" asp-page-handler="UpdateAndShow" class="btn btn-secondary m-2">עדכון והצג</button>
                    <button type="button" id="exportButton2" class="btn btn-success m-2">עדכון ויצוא ל-Word</button>
                </div>
            </form>
        }
    }
    else
    {
        <h2>אנא בחר בחינה מהרשימה כדי להכין רשימת ייצוא.</h2>
    }
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get the default filename from the C# model.
            var defaultFileName = document.getElementById('fileNameInput').value;

            // Find all buttons with a specific ID pattern and attach a single event listener.
            var exportButtons = document.querySelectorAll('#exportButton1, #exportButton2');
            exportButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    var userFileName = prompt("אנא הזן שם לקובץ:", defaultFileName);

                    if (userFileName === null) {
                        // User clicked "Cancel" on the prompt. Stop form submission.
                        return;
                    }

                    // Set the value of the hidden filename input.
                    // Use the user's input, or if it's empty, revert to the default.
                    document.getElementById('fileNameInput').value = userFileName || defaultFileName;

                    // Find the closest form and submit it.
                    var form = event.target.closest('form');
                    if (form) {
                        form.submit();
                    }
                });
            });
        });
    </script>
}
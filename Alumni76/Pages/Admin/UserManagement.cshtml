@page
@model UserManagementModel
@{
    ViewData["Title"] = "ניהול הרשאות משתמשים";
}

<div class="full-width-content">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @Html.Raw(TempData["SuccessMessage"])
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }


    <div class="main-container">
        <div class="buttunBox">
            <br /><br />
            <button type="button" class="btn btn-primary filter-button" data-bs-toggle="modal" data-bs-target="#filterSortModal">
                סינון
            </button>
            <br />
            <form method="post" asp-page-handler="ResetSort" class="d-inline">
                <button type="submit" class="btn btn-primary filter-button">איפוס</button>
            </form>

            <br /><br /><br /><br /><br /><br />

            @*  Emergency button   *@

            <form method="post" asp-page-handler="EmergencyPasswordReset" class="d-inline">
                <button type="submit" class="btn btn-warning filter-button">יצירת סיסמאות לכולם</button>
            </form>
        </div>
        <div class="userTable">
            @if (Model.DisplayUsers != null && Model.DisplayUsers.Any())
            {
                var sortState = (List<string>)(ViewData["SortState"])!;
                Func<string, string> getSortDir = colName =>
                {
                    if (sortState != null && sortState.Any() && sortState.First().StartsWith(colName))
                    {
                        return sortState.First().EndsWith("_asc") ? "desc" : "asc";
                    }
                    return "asc";
                };
                Func<string, string> getSortDirIcon = colName =>
                {
                    if (sortState == null || !sortState.Any() || !sortState.First().StartsWith(colName)) return "";
                    return sortState.First().EndsWith("_asc") ? "up" : "down";
                };

                // Helper to check if this column is the one currently sorted
                Func<string, bool> isCurrentSort = colName =>
                sortState != null && sortState.Any() && sortState.First().StartsWith(colName);

                <table class="table table-bordered table-striped mt-3 user-table-compact">
                    <thead>
                        <tr style="background: #a0a0a0;">
                            <th style="width: 2%;"></th>
                            <th style="width: 5%;" class="sortable-header @(isCurrentSort("FirstName") ? "active-sort-col" : "")">
                                <a asp-page="UserManagement" asp-route-sort="FirstName" asp-route-dir="@getSortDir("FirstName")">
                                    שם פרטי <i class="bi @getSortDirIcon("FirstName")"></i>
                                </a>
                            </th>
                            <th style="width: 8%;" class="sortable-header @(isCurrentSort("LastName") ? "active-sort-col" : "")">
                                <a asp-page="UserManagement" asp-route-sort="LastName" asp-route-dir="@getSortDir("LastName")">
                                    שם משפחה <i class="bi @getSortDirIcon("LastName")"></i>
                                </a>
                            </th>
                            <th style="width: 8%;">שם נעורים</th>
                            <th style="width: 3%;" class="sortable-header @(isCurrentSort("Class") ? "active-sort-col" : "")">
                                <a asp-page="UserManagement" asp-route-sort="Class" asp-route-dir="@getSortDir("Class")">
                                    כיתה <i class="bi @getSortDirIcon("Class")"></i>
                                </a>
                            </th>
                            <th style="width: 15%;">אימייל</th>
                            <th style="width: 8%;" class="text-center">פעיל</th>
                            <th style="width: 8%;" class="text-center">אדמין</th>
                            <th style="width: 8%;" class="text-center"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.DisplayUsers)
                        {
                            <tr data-user-id="@user.UserId">
                                <form method="post" asp-page-handler="UpdateUser">
                                    <input type="hidden" name="userId" value="@user.UserId" />
                                <td>@(Model.DisplayUsers.IndexOf(user) + 1)</td>
                                <td>@user.FirstName</td>
                                <td>@user.LastName</td>
                                <td>@user.MaidenName</td>
                                <td>@user.Class</td>
                                <td style="text-align: left; direction: ltr;">@user.Email</td>
                                <td class="text-center">
                                    <input type="checkbox" name="isActive" value="true" @(user.Active ? "checked" : "") class="form-check-input" />
                                    <input type="hidden" name="isActive" value="false" />
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" name="isAdmin" value="true" @(user.IsAdmin ? "checked" : "") class="form-check-input" />
                                    <input type="hidden" name="isAdmin" value="false" />
                                </td>
                                <td class="text-center">
                                    <button type="submit" class="btn btn-sm btn-success">שמור</button>
                                </td>
                                </form>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <h3 class="mt-4">אין בוגרים להצגה במערכת.</h3>
            }
        </div>
    </div>
</div>

<style>
    .main-container {
        display: flex;
        width: 80%;
        padding: 0;
        margin: 0;
    }

    .buttunBox {
        flex: 1;
        direction: rtl;
    }

    .filter-button {
        margin: 40px 0px 0px 20px;
    }

    .userTable {
        flex: 20;
        padding: 0px 20px;
    }

    th a {
        text-decoration: none;
        color: inherit;
    }

    .user-table-compact {
        table-layout: fixed; /* Forces the table to respect the widths we set above */
        width: 100%;
        word-wrap: break-word; /* Prevents long emails from breaking the layout */
    }

        .user-table-compact thead th {
            background-color: #f2f2f2 !important; /* light gray header */
            vertical-align: middle;
        }

        /* Target the three columns to be identical */
        .user-table-compact td:nth-child(3),
        .user-table-compact td:nth-child(4),
        .user-table-compact td:nth-child(5) {
            width: 10%;
        }

    .user-table-compact {
        table-layout: fixed;
        width: 100%;
        margin-top: 20px; /* Space between filter and table */
    }

        /* Target headers and cells for better vertical spacing */
        .user-table-compact th,
        .user-table-compact td {
            padding-top: 12px !important; /* Increase upper padding */
            padding-bottom: 12px !important; /* Increase lower padding */
            vertical-align: middle !important; /* Center text vertically */
            line-height: 1.5; /* Better readability for Hebrew */
        }

        /* Optional: Slight color change on hover to make rows easier to follow */
        .user-table-compact tbody tr:hover {
            background-color: rgba(0,0,0,0.05) !important;
        }

        /* Style the header for better contrast */
        .user-table-compact thead th {
            background-color: #a0a0a0 !important;
            color: white;
            text-align: center;
        }

            /* Ensure links in headers (for sorting) remain white */
            .user-table-compact thead th a {
                color: white;
                display: block; /* Makes the whole header area clickable */
            }

        /*  for sortable columen headers  */
        /* 1. The default look for non-sortable headers */
        .user-table-compact thead th {
            color: #e0e0e0; /* Slightly dimmed white for static columns */
        }

    /* 2. The distinct look for SORTABLE columns */
    .sortable-header a {
        color: #ffeb3b !important; /* Golden-yellow to signal "Action" */
        font-weight: 600;
        text-decoration: none;
    }

    /* 3. Hover effect to make it feel like a button */
    .sortable-header:hover {
        background-color: #888888 !important;
    }

        .sortable-header:hover a {
            color: #ffffff !important; /* Turns white on hover */
        }

    /* 4. Active sort column (the one currently being used) */
    .active-sort-col {
        background-color: #7a7a7a !important; /* Slightly darker background */
        border-bottom: 3px solid #ffeb3b !important; /* Underline the active one */
    }

    th {
        text-align: right;
    }

    .form-check-input {
        cursor: pointer;
    }
</style>


@section Scripts {
    @await Html.PartialAsync("_FilterDialog", Model.FilterModel)
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}